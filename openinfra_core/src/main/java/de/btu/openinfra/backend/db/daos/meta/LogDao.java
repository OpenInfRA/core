package de.btu.openinfra.backend.db.daos.meta;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Locale;

import de.btu.openinfra.backend.db.MappingResult;
import de.btu.openinfra.backend.db.OpenInfraSchemas;
import de.btu.openinfra.backend.db.daos.OpenInfraDao;
import de.btu.openinfra.backend.db.jpa.model.meta.Log;
import de.btu.openinfra.backend.db.pojos.meta.LogPojo;
import de.btu.openinfra.backend.helper.OpenInfraTime;

/**
 * This class represents the Log and is used to access the underlying layer
 * generated by JPA.
 *
 * @author <a href="http://www.b-tu.de">BTU</a> DBIS
 *
 */
public class LogDao
    extends OpenInfraDao<LogPojo, Log> {

    /**
     * This is the required constructor which calls the super constructor and in
     * turn creates the corresponding entity manager.
     *
     * @param schema           the required schema
     */
    public LogDao(OpenInfraSchemas schema) {
        super(null, schema, Log.class);
    }

    @Override
    public LogPojo mapToPojo(Locale locale, Log l) {
        return mapPojoStatically(l);
    }

    /**
     * This method implements the method mapToPojo in a static way.
     *
     * @param at     the model object
     * @return       the POJO object when the model object is not null else null
     */
    public static LogPojo mapPojoStatically(Log l) {
        if(l != null) {
            LogPojo pojo = new LogPojo(l);

            pojo.setUserId(l.getUserId());
            pojo.setUserName(l.getUserName());
            pojo.setCreatedOn(OpenInfraTime.format(l.getCreatedOn()));
            pojo.setLogger(LoggerDao.mapPojoStatically(l.getLoggerBean()));
            pojo.setLevel(LevelDao.mapPojoStatically(l.getLevelBean()));
            pojo.setMessage(l.getMessage());
            return pojo;
        } else {
            return null;
        }
    }

    @Override
    public MappingResult<Log> mapToModel(LogPojo pojo, Log log) {
        if(pojo != null) {
            mapToModelStatically(pojo, log);
            return new MappingResult<Log>(log.getId(), log);
        }
        else {
            return null;
        }
    }

    /**
     * This method implements the method mapToModel in a static way.
     * @param pojo the POJO object
     * @param log the pre initialized model object
     * @return return a corresponding JPA model object or null if the pojo
     * object is null
     */
    public Log mapToModelStatically(LogPojo pojo, Log log) {
        Log resultLog = null;
        if(pojo != null) {
            resultLog = log;
            if(resultLog == null) {
                resultLog = new Log();
                resultLog.setId(pojo.getUuid());
            }

            try {
                // TODO this must be placed somewhere in the properties
                String format = "yyyy-MM-dd'T'HH:mm:ssX";
                SimpleDateFormat df = new SimpleDateFormat(format);
                resultLog.setCreatedOn(df.parse(pojo.getCreatedOn()));
            } catch (ParseException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }
            resultLog.setMessage(pojo.getMessage());
            resultLog.setUserId(pojo.getUserId());
            resultLog.setUserName(pojo.getUserName());
            resultLog.setLevelBean(LevelDao.mapToModelStatically(
                    pojo.getLevel(),
                    null));
            resultLog.setLoggerBean(LoggerDao.mapToModelStatically(
                    pojo.getLogger(),
                    null));
        }
        return resultLog;
    }

    /**
     * Creates an empty log pojo.
     * @return an empty log pojo
     */
    public LogPojo newLog() {
        return newPojoStatically();
    }

    /**
     * This method implements the method newLog in a static way.
     * @return an empty log pojo
     */
    public static LogPojo newPojoStatically() {
        LogPojo newLogPojo = new LogPojo();
        newLogPojo.setLevel(LevelDao.newPojoStatically());
        newLogPojo.setLogger(LoggerDao.newPojoStatically());

        return newLogPojo;
    }
}
